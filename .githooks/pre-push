#!/bin/sh
echo "üîç PRE-PUSH: Check Quality Gate..."

# Verify that SonarQube is on
if ! curl -s --max-time 1 http://localhost:9000/api/system/status > /dev/null; then
    echo "‚ö†Ô∏è  WARNING: SonarQube not responding on localhost:9000."
    echo "    Do you want to skip quality controls? (y/n)"
    exec < /dev/tty
    read answer
    if [ "$answer" != "y" ]; then
        exit 1
    fi
    echo "‚è© Skipping Quality Gate (Risky Push)..."
    exit 0
fi

# Verify that token exists
if [ -z "$SONAR_TOKEN" ]; then
    echo "‚ùå ERROR: Environment variable SONAR_TOKEN not found."
    exit 1
fi

echo "üßπ Preparing Test Environment..."
# Reset Chemo_TEST
./refresh-test-db.sh Chemo_TEST

if [ $? -ne 0 ]; then
    echo "‚ùå PUSH BLOCKED: Failed to reset test database."
    exit 1
fi

echo "‚úÖ Starting Analysis..."

# Execute Maven Analysis
./mvnw -B verify sonar:sonar \
  -Dsonar.host.url=http://localhost:9000 \
  -Dsonar.token=$SONAR_TOKEN \
  -Dsonar.qualitygate.wait=true

# Verify output
if [ $? -ne 0 ]; then
    echo "‚ùå PUSH BLOCKED: Quality Gate failed."
    echo "   Check full report on: http://localhost:9000"
    exit 1
fi

echo "üöÄ Quality Gate Passed."
exit 0